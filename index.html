<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spelling and Riddle Game</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap");

        /* Ensures hidden elements are not rendered */
        [hidden] { display: none !important; }

        :root {
            --bg: #f0f8ff; --text: #444; --brand: #ff69b4; --brand-dark: #d1478e;
            --title: #ff6347; --title-shadow: #ffb6c1; --accent: #ff4500;
            --ok: #2e8b57; --no: #dc143c; --next-btn-bg: #4caf50; --next-btn-shadow: #388e3c;
        }
        * { box-sizing: border-box; }
        body {
            font-family: "Fredoka One", cursive, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            text-align: center;
            padding: 20px;
        }
        #container {
            max-width: 900px; margin: 0 auto; background-color: #ffffff;
            padding: 30px; border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 5px solid #fff;
        }
        h1 { color: var(--title); font-size: 3.2em; text-shadow: 2px 2px 0px var(--title-shadow); margin-bottom: 14px; }
        p { font-size: 1.05em; color: #555; line-height: 1.5; }
        .controls { margin: 14px 0 8px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

        #word-input-container {
            width: 100%; padding: 10px; border-radius: 15px;
            border: 3px dashed #add8e6; margin-bottom: 8px; background-color: #f0f8ff;
            display: flex; flex-direction: column; gap: 8px;
        }
        .word-entry { display: flex; align-items: center; gap: 10px; padding: 5px; }
        .entry-number { font-weight: bold; color: var(--brand-dark); font-size: 1.1em; min-width: 25px; text-align: right; }
        .word-input-field {
            flex-grow: 1; border: none; border-bottom: 2px solid #ccc; background-color: transparent;
            font-family: "Fredoka One", cursive; font-size: 1em; outline: none; padding: 5px;
        }
        .word-input-field:focus { border-bottom-color: var(--brand); }

        .speak-button {
            padding: 6px 10px;
            font-size: 1em;
            border-radius: 10px;
            background: #fff;
            color: var(--brand);
            border: 2px solid var(--brand);
            cursor: pointer;
        }
        .speak-button:active { transform: translateY(1px); }

        button {
            background-color: var(--brand); color: white; padding: 12px 22px; border: none;
            border-radius: 50px; font-size: 1.1em; cursor: pointer; box-shadow: 0 4px var(--brand-dark);
            font-family: "Fredoka One", cursive;
        }
        button:active { transform: translateY(2px); box-shadow: 0 2px var(--brand-dark); }
        button.secondary { background: #eee; color: #333; box-shadow: 0 4px #ccc; }
        button.next-button {
            background-color: var(--next-btn-bg);
            box-shadow: 0 4px var(--next-btn-shadow);
        }
        button.end-game-btn {
            background-color: var(--no);
            box-shadow: 0 4px #a51130;
        }
        #output { margin-top: 22px; text-align: left; }
        #riddle-box {
            padding: 20px; border-radius: 15px; margin-top: 20px;
            background-color: #f7faff; border-left: 10px solid var(--brand);
            min-height: 150px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        .riddle-title {
            font-size: 1.6em; color: var(--accent); font-weight: bold; margin-bottom: 14px; text-align: center;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--brand);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform-rotate(360deg); }
        }
        .clues-list {
            list-style-type: 'ðŸ‘‰ ';
            padding-left: 20px;
            text-align: left;
            margin: 10px 0;
        }
        .clues-list li {
            margin-bottom: 8px;
            font-size: 1.1em;
            color: #555;
            line-height: 1.5;
        }
        .sentences-box {
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed #9370db;
            border-radius: 10px;
            background-color: #e6e6fa;
            text-align: left;
        }
        .sentences-box h3 {
            margin-top: 0;
            color: #4b0082;
            font-size: 1.3em;
            text-shadow: none;
        }
        .sentences-box p {
            margin: 0 0 10px;
            font-size: 1em;
            line-height: 1.4;
        }
        .guess-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .guess-input {
            padding: 8px 12px;
            font-size: 1em;
            font-family: "Fredoka One", cursive;
            border: 2px solid #ccc;
            border-radius: 10px;
            outline: none;
            text-align: center;
        }
        .guess-input.correct { border-color: var(--ok); color: var(--ok); }
        .guess-input.incorrect { border-color: var(--no); color: var(--no); }
        #helper { margin-top: 8px; font-size: .95em; color: #666; text-align: center; }
        #scoreDisplay { font-size: 1.1em; font-weight: bold; color: var(--brand-dark); margin-top: 10px; }
        #correctScoreDisplay, #wrongScoreDisplay {
            font-size: 1.1em; font-weight: bold; margin-top: 5px;
        }
        #correctScoreDisplay { color: var(--ok); }
        #wrongScoreDisplay { color: var(--no); }
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 15px;
            width: 80%; max-width: 400px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }
        .close-button {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus {
            color: #000; text-decoration: none; cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>ðŸŒŸ Spelling & Riddle Game ðŸŒŸ</h1>
        <p>Enter up to 10 words, then solve the riddles!</p>
        <div id="word-input-container"></div>
        <div class="controls">
            <button id="btnGenerate">Generate Riddles!</button>
            <button id="btnRandom">Generate 10 Random Words</button>
            <button id="btnSpeakAll" class="secondary">ðŸ”Š Read All</button>
            <button class="secondary" id="btnClear">Clear</button>
            <button id="btnEndGame" class="end-game-btn" hidden>End Game</button>
        </div>
        <div id="helper" class="helper"></div>
        <div id="scoreDisplay">Session Score: 0</div>
        <div id="correctScoreDisplay">Correct Answers: 0</div>
        <div id="wrongScoreDisplay">Wrong Answers: 0</div>

        <div id="output">
            <div id="riddle-box">
                <div class="riddle-title">ðŸ¤” Let's Play! ðŸ¤”</div>
                <p>Add some words above and click "Generate Riddles!".</p>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message"></p>
        </div>
    </div>
    <script>
        const MAX_WORDS = 10;
        const scoreDisplay = document.getElementById("scoreDisplay");
        const correctScoreDisplay = document.getElementById("correctScoreDisplay");
        const wrongScoreDisplay = document.getElementById("wrongScoreDisplay");
        const wordInputContainer = document.getElementById('word-input-container');
        const riddleBox = document.getElementById("riddle-box");
        const helper = document.getElementById("helper");
        const btnRandom = document.getElementById("btnRandom");
        const btnSpeakAll = document.getElementById("btnSpeakAll");
        const btnGenerate = document.getElementById("btnGenerate");
        const btnClear = document.getElementById("btnClear");
        const btnEndGame = document.getElementById("btnEndGame");

        let sessionScore = 0;
        let correctScore = 0;
        let wrongScore = 0;
        let wordsToGuess = [];
        let currentWordIndex = 0;

        // ====== TTS (Web Speech API) ======
        const synth = window.speechSynthesis;
        let voices = [];

        function loadVoices() {
            voices = synth.getVoices() || [];
        }
        loadVoices();
        if ('onvoiceschanged' in synth) {
            synth.onvoiceschanged = loadVoices;
        }

        function pickVoice() {
            // Prioritize English voices, then Italian as a fallback
            const preferred = ['en-US', 'en-GB', 'it-IT'];
            for (const tag of preferred) {
                const v = voices.find(v => v.lang === tag);
                if (v) return v;
            }
            // Fallback to any voice in the preferred language prefix
            for (const prefix of ['en','it']) {
                const v = voices.find(v => v.lang && v.lang.startsWith(prefix));
                if (v) return v;
            }
            return voices[0] || null;
        }

        function speakText(text, opts = {}) {
            const t = (text || '').trim();
            if (!t) return;
            const utter = new SpeechSynthesisUtterance(t);
            const v = pickVoice();
            if (v) {
                utter.voice = v;
                utter.lang = v.lang;
            } else {
                utter.lang = 'en-US';
            }
            utter.rate = opts.rate ?? 0.95;
            utter.pitch = opts.pitch ?? 1.0;
            utter.volume = opts.volume ?? 1.0;
            synth.cancel();
            synth.speak(utter);
        }

        // ====== Word bank for random words ======
        const wordBank = [
            "cat","dog","apple","banana","house","tree","car","book","river","sun",
            "moon","star","fish","bird","flower","train","phone","chair","cloud","cake",
            "ball","shoes","computer","mouse","desk","pen","school","street","window","door",
            "water","fire","earth","wind","love","happy","smile","friend","family","music"
        ];

        // ====== Modal box ======
        const modal = document.getElementById("modal");
        const modalMessage = document.getElementById("modal-message");
        const closeButton = document.querySelector(".close-button");
        function showModal(message) {
            modalMessage.textContent = message;
            modal.style.display = "flex";
        }
        closeButton.onclick = () => { modal.style.display = "none"; };
        window.onclick = (event) => { if (event.target === modal) modal.style.display = "none"; };

        // ====== Utils ======
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateRandomWords() {
            const inputs = document.querySelectorAll(".word-input-field");
            let chosen = [];
            while (chosen.length < MAX_WORDS) {
                let rndWord = wordBank[Math.floor(Math.random() * wordBank.length)];
                if (!chosen.includes(rndWord)) {
                    chosen.push(rndWord);
                }
            }
            inputs.forEach((inp, i) => { inp.value = chosen[i]; });
        }

        // ====== LLM hints ======
        async function fetchRiddleAndSentences(word) {
            riddleBox.innerHTML = `<div class="loading-spinner"></div>`;
            const systemPrompt = `You are a content generator for a children's word game. Your task is to create a simple riddle and simple sentences for a given word. The riddle must be short and easy, without the target word. The sentences must be two or three, very simple, and use the word in a context a child can understand. The content must be in English. Format the response exactly like this:\nRiddle: [riddle text]\nSentences: [first sentence text]. [second sentence text]. [third sentence text].\n`;
            const userQuery = `Provide a riddle and sentences for the word "${word}".`;
            const apiKey = "AlzaSyAgJOxCqhgptws_ll9kd4nKH2cZwpRF_Ok"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const MAX_RETRIES = 5;
            const initialDelay = 1000;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        }
                    }

                    // Retry on non-OK response
                    const delay = initialDelay * Math.pow(2, i);
                    console.warn(`Attempt ${i + 1} failed with status ${response.status}. Retrying in ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));

                } catch (error) {
                    // This block handles network errors and timeouts.
                    if (error.name === 'AbortError') {
                        console.error(`Request timed out. (Attempt ${i + 1} of ${MAX_RETRIES})`);
                    } else {
                        console.error(`Error fetching hints on attempt ${i + 1}:`, error);
                    }

                    // Always retry on error unless it's the last attempt.
                    if (i < MAX_RETRIES - 1) {
                        const delay = initialDelay * Math.pow(2, i);
                        console.warn(`Retrying in ${delay}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            }
            console.error("Failed to fetch riddle after multiple attempts.");
            return `Riddle: I'm sorry, I couldn't generate a riddle after multiple attempts. This may be due to a temporary server issue or a network problem. Please try again later.\nSentences: I'm sorry, I couldn't generate sentences.`;
        }

        // ====== Game logic ======
        async function loadNextRiddle() {
            if (currentWordIndex >= wordsToGuess.length) {
                riddleBox.innerHTML = `<div class="riddle-title">ðŸŽ‰ Game Over! ðŸŽ‰</div><p>You have solved all the riddles!</p><p>Click "Clear" to play again.</p>`;
                btnGenerate.hidden = false;
                btnRandom.hidden = false;
                btnSpeakAll.hidden = false;
                btnClear.hidden = false;
                btnEndGame.hidden = true;
                return;
            }
            const currentWord = wordsToGuess[currentWordIndex];
            const contentText = await fetchRiddleAndSentences(currentWord);

            const parts = contentText.split('\n');
            let riddle = 'No riddle available.';
            let sentences = 'No sentences available.';
            
            for (const part of parts) {
                if (part.startsWith('Riddle:')) {
                    riddle = part.substring('Riddle:'.length).trim();
                } else if (part.startsWith('Sentences:')) {
                    sentences = part.substring('Sentences:'.length).trim();
                }
            }

            riddleBox.innerHTML = '';
            
            const title = document.createElement('div');
            title.className = 'riddle-title';
            title.textContent = 'ðŸ¤” Can you guess the word? ðŸ¤”';
            riddleBox.appendChild(title);

            const riddleText = document.createElement('p');
            riddleText.textContent = riddle;
            riddleBox.appendChild(riddleText);

            const sentencesBox = document.createElement('div');
            sentencesBox.className = 'sentences-box';
            const sentencesTitle = document.createElement('h3');
            sentencesTitle.textContent = 'Let\'s use the word in sentences:';
            sentencesBox.appendChild(sentencesTitle);
            const sentencesParagraph = document.createElement('p');
            sentencesParagraph.textContent = sentences;
            sentencesBox.appendChild(sentencesParagraph);
            riddleBox.appendChild(sentencesBox);

            const readAllBtn = document.createElement('button');
            readAllBtn.textContent = 'ðŸ”Š Read All';
            readAllBtn.className = 'secondary';
            readAllBtn.style.marginTop = '15px';
            readAllBtn.onclick = () => speakText(`${riddle}. ${sentences}`);
            riddleBox.appendChild(readAllBtn);

            const guessContainer = document.createElement('div');
            guessContainer.className = 'guess-input-container';
            const guessInput = document.createElement('input');
            guessInput.type = 'text';
            guessInput.className = 'guess-input';
            guessInput.placeholder = 'Your guess...';
            guessInput.autocomplete = 'off';
            guessContainer.appendChild(guessInput);

            const checkButton = document.createElement('button');
            checkButton.textContent = 'Check';
            checkButton.onclick = () => checkGuess(guessInput, currentWord, checkButton);
            guessContainer.appendChild(checkButton);

            riddleBox.appendChild(guessContainer);
        }

        function checkGuess(guessInput, correctWord, checkButton) {
            if (guessInput.value.toLowerCase().trim() === correctWord.toLowerCase().trim()) {
                guessInput.classList.remove('incorrect');
                guessInput.classList.add('correct');
                sessionScore++;
                correctScore++;
                updateScores();
                showModal("Correct! Great job!");
                checkButton.style.display = 'none';

                const nextButton = document.createElement('button');
                nextButton.textContent = 'Next Word';
                nextButton.classList.add('next-button');
                nextButton.style.marginTop = '10px';
                nextButton.onclick = () => {
                    currentWordIndex++;
                    loadNextRiddle();
                };

                const guessContainer = document.querySelector('.guess-input-container');
                guessContainer.appendChild(nextButton);
            } else {
                guessInput.classList.remove('correct');
                guessInput.classList.add('incorrect');
                sessionScore--;
                wrongScore++;
                updateScores();
                showModal("Oops! That's not right. Try again!");
            }
        }

        function updateScores() {
            scoreDisplay.textContent = `Session Score: ${sessionScore}`;
            correctScoreDisplay.textContent = `Correct Answers: ${correctScore}`;
            wrongScoreDisplay.textContent = `Wrong Answers: ${wrongScore}`;
        }

        function generateRiddles() {
            wordsToGuess = [];
            document.querySelectorAll('.word-input-field').forEach(inp => {
                const w = inp.value.trim().toLowerCase();
                if (w) wordsToGuess.push(w);
            });

            const uniqueWords = [...new Set(wordsToGuess)];
            wordsToGuess = uniqueWords;
            shuffleArray(wordsToGuess);

            if (wordsToGuess.length === 0) {
                helper.textContent = "Please add at least one word.";
                return;
            }

            helper.textContent = `Words to guess: ${wordsToGuess.length}`;
            wordInputContainer.hidden = true;
            
            btnGenerate.hidden = true;
            btnRandom.hidden = true;
            btnSpeakAll.hidden = true;
            btnClear.hidden = true;
            btnEndGame.hidden = false;

            currentWordIndex = 0;
            sessionScore = 0;
            correctScore = 0;
            wrongScore = 0;
            updateScores();
            loadNextRiddle();
        }

        function createWordInputs() {
            wordInputContainer.innerHTML = '';
            for (let i = 1; i <= MAX_WORDS; i++) {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'word-entry';

                const numberSpan = document.createElement('span');
                numberSpan.className = 'entry-number';
                numberSpan.textContent = `${i}.`;
                entryDiv.appendChild(numberSpan);

                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.className = 'word-input-field';
                inputField.placeholder = 'Type the word...';
                inputField.autocomplete = 'off';
                entryDiv.appendChild(inputField);

                const speakBtn = document.createElement('button');
                speakBtn.type = 'button';
                speakBtn.className = 'speak-button';
                speakBtn.title = 'Speak';
                speakBtn.setAttribute('aria-label', `Speak word ${i}`);
                speakBtn.textContent = 'ðŸ”Š';
                speakBtn.addEventListener('click', () => {
                    const text = inputField.value.trim();
                    if (text) speakText(text);
                });
                entryDiv.appendChild(speakBtn);

                wordInputContainer.appendChild(entryDiv);
            }
        }
        
        function resetGame() {
            document.querySelectorAll('.word-input-field').forEach(inp => inp.value = '');
            riddleBox.innerHTML = `<div class="riddle-title">ðŸ¤” Let's Play! ðŸ¤”</div><p>Add some words above and click "Generate Riddles!".</p>`;
            helper.textContent = "";
            sessionScore = 0;
            correctScore = 0;
            wrongScore = 0;
            currentWordIndex = 0;
            wordsToGuess = [];
            updateScores();
            wordInputContainer.hidden = false;
            
            btnGenerate.hidden = false;
            btnRandom.hidden = false;
            btnSpeakAll.hidden = false;
            btnClear.hidden = false;
            btnEndGame.hidden = true;
        }

        // Event listeners
        btnGenerate.addEventListener("click", generateRiddles);
        btnRandom.addEventListener("click", generateRandomWords);
        btnClear.addEventListener("click", resetGame);
        btnEndGame.addEventListener("click", resetGame);

        btnSpeakAll.addEventListener("click", async () => {
            const inputs = document.querySelectorAll(".word-input-field");
            const delay = (ms) => new Promise(res => setTimeout(res, ms));
            for (const inp of inputs) {
                const t = inp.value.trim();
                if (t) {
                    speakText(t);
                    await delay(800);
                }
            }
        });

        // Initialization
        createWordInputs();
    </script>
</body>
</html>
