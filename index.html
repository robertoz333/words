<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spelling & Riddle Game</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap");
    :root {
      --bg: #f0f8ff; --text: #444; --brand: #ff69b4; --brand-dark: #d1478e;
      --title: #ff6347; --title-shadow: #ffb6c1; --accent: #ff4500;
      --ok: #2e8b57; --no: #dc143c;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Fredoka One", cursive, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      text-align: center;
      padding: 20px;
    }
    #container {
      max-width: 900px; margin: 0 auto; background-color: #ffffff;
      padding: 30px; border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border: 5px solid #fff;
    }
    h1 { color: var(--title); font-size: 3.2em; text-shadow: 2px 2px 0px var(--title-shadow); margin-bottom: 14px; }
    p { font-size: 1.05em; color: #555; line-height: 1.5; }
    .controls { margin: 14px 0 8px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

    /* Lista numerata di 10 campi parola */
    #word-input-container {
      width: 100%; padding: 10px; border-radius: 15px;
      border: 3px dashed #add8e6; margin-bottom: 8px; background-color: #f0f8ff;
      display: flex; flex-direction: column; gap: 8px;
    }
    .word-entry { display: flex; align-items: center; gap: 10px; padding: 5px; }
    .entry-number { font-weight: bold; color: var(--brand-dark); font-size: 1.1em; min-width: 25px; text-align: right; }
    .word-input-field {
      flex-grow: 1; border: none; border-bottom: 2px solid #ccc; background-color: transparent;
      font-family: "Fredoka One", cursive; font-size: 1em; outline: none; padding: 5px;
    }
    .word-input-field:focus { border-bottom-color: var(--brand); }
    .listen-icon {
      cursor: pointer; font-size: 1.2em; user-select: none; visibility: hidden;
    }
    .word-input-field:not(:placeholder-shown) + .listen-icon { visibility: visible; }

    button {
      background-color: var(--brand); color: white; padding: 12px 22px; border: none;
      border-radius: 50px; font-size: 1.1em; cursor: pointer; box-shadow: 0 4px var(--brand-dark);
      font-family: "Fredoka One", cursive;
    }
    button:active { transform: translateY(2px); box-shadow: 0 2px var(--brand-dark); }
    button.secondary { background: #eee; color: #333; box-shadow: 0 4px #ccc; }

    #output { margin-top: 22px; text-align: left; }

    /* Unico box degli indovinelli */
    #riddle-box {
      padding: 20px; border-radius: 15px; margin-top: 20px;
      background-color: #f7faff; border-left: 10px solid var(--brand);
    }
    .riddle-title {
      font-size: 1.6em; color: var(--accent); font-weight: bold; margin-bottom: 14px; text-align: center;
    }
    .sentence {
      font-size: 1.05em; margin-bottom: 14px; line-height: 2; font-style: italic; color: #555;
      display: flex; align-items: center;
    }
    .sentence-input {
      border: none; border-bottom: 3px dashed #aaa; font-family: "Fredoka One", cursive;
      font-size: 1em; text-align: center; background-color: transparent; min-width: 90px; padding: 2px 4px;
    }
    .sentence-input:focus { outline: none; border-bottom: 3px solid var(--accent); }
    .listen-icon-sentence { cursor: pointer; margin-right: 8px; font-size: 1.1em; vertical-align: middle; }
    .correct { color: var(--ok); border-bottom-color: var(--ok) !important; font-weight: bold; }
    .incorrect { color: var(--no); border-bottom-color: var(--no) !important; }

    .helper { margin-top: 8px; font-size: .95em; color: #666; text-align: center; }
    #scoreDisplay { font-size: 1.1em; font-weight: bold; color: var(--brand-dark); margin-top: 10px; }
  </style>
</head>
<body>
  <div id="container">
    <h1>ðŸŒŸ Spelling & Riddle Game ðŸŒŸ</h1>
    <p>Inserisci fino a 10 parole e poi risolvi gli indovinelli nel box qui sotto!</p>

    <div id="word-input-container"></div>

    <div class="controls">
      <button id="btnGenerate">Genera Indovinelli!</button>
      <button class="secondary" id="btnClear">Pulisci</button>
    </div>

    <div id="helper" class="helper"></div>
    <div id="scoreDisplay">Score: 0</div>
    <div id="output"></div>
  </div>

  <script>
    const MAX_WORDS = 10;
    const scoreDisplay = document.getElementById("scoreDisplay");
    const wordInputContainer = document.getElementById('word-input-container');

    // ====== TTS robusto (caricamento voci + resume anti-scatti) ======
    const synth = window.speechSynthesis;
    let voices = [];
    let speechKeepAliveInterval = null;

    async function getVoicesAsync() {
      voices = synth.getVoices();
      if (voices && voices.length) return voices;
      await new Promise(resolve => synth.addEventListener('voiceschanged', resolve, { once: true }));
      voices = synth.getVoices();
      return voices;
    }

    async function speakText(text) {
      if (!text || !synth) return;
      await getVoicesAsync();
      if (synth.speaking) synth.cancel();
      clearInterval(speechKeepAliveInterval);

      const utter = new SpeechSynthesisUtterance(text);
      const v =
        voices.find(v => v.name === 'Google UK English Female') ||
        voices.find(v => /en-GB/i.test(v.lang) && /Female/i.test(v.name)) ||
        voices.find(v => /en-GB/i.test(v.lang)) ||
        voices.find(v => /^en[-_]/i.test(v.lang));
      if (v) { utter.voice = v; utter.lang = v.lang; } else { utter.lang = 'en-GB'; }
      utter.pitch = 1; utter.rate = 1;

      utter.onstart = () => {
        speechKeepAliveInterval = setInterval(() => {
          if (synth.speaking) synth.resume();
          else clearInterval(speechKeepAliveInterval);
        }, 1000);
      };
      utter.onend = () => clearInterval(speechKeepAliveInterval);
      utter.onerror = () => clearInterval(speechKeepAliveInterval);

      synth.speak(utter);
    }

    // ====== Input parole: 10 righe numerate ======
    function createWordInputs() {
      wordInputContainer.innerHTML = '';
      for (let i = 1; i <= MAX_WORDS; i++) {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'word-entry';

        const numberSpan = document.createElement('span');
        numberSpan.className = 'entry-number';
        numberSpan.textContent = `${i}.`;
        entryDiv.appendChild(numberSpan);

        const inputField = document.createElement('input');
        inputField.type = 'text';
        inputField.className = 'word-input-field';
        inputField.placeholder = 'Digita la parola...';
        inputField.autocomplete = 'off';
        entryDiv.appendChild(inputField);

        const listenIcon = document.createElement('span');
        listenIcon.textContent = 'ðŸ”Š';
        listenIcon.className = 'listen-icon';
        listenIcon.onclick = () => {
          const w = inputField.value.trim();
          if (w) speakText(w);
        };
        entryDiv.appendChild(listenIcon);

        wordInputContainer.appendChild(entryDiv);
      }
    }

    // ====== Mappa indovinelli base ======
    const riddleMap = {
      sun: "I am a giant star. I give you light and heat. What am I?",
      moon: "I appear at night. Sometimes I'm a full circle, sometimes just a slice. What am I?",
      dog: "I am a loyal friend. I wag my tail and bark. What am I?",
      cat: "I am a pet with soft fur. I like to chase mice and I say 'meow'. What am I?",
      book: "I have pages and a cover. I take you on adventures. What am I?",
      car: "I have four wheels and an engine and drive on roads. What am I?",
      tree: "I have a trunk and branches, and my leaves fall in autumn. What am I?",
      happy: "This feeling is the opposite of sad. It makes you smile. What is it?",
      run: "This is an action faster than walking. What is it?",
      sea: "I am a huge body of salt water with waves. What am I?",
      school: "I am a place with classrooms where children learn. What am I?"
    };

    // 3 frasi per parola
    function generateContextualSentences(word, count = 3) {
      const w = word.toLowerCase();
      const set = new Set();

      if (riddleMap[w]) {
        set.add(riddleMap[w].replace("What am I?", "The answer is ...."));
      } else {
        const syllables = (w.match(/[aeiouy]+/g) || []).length || 1;
        set.add(`I start with '${w[0]}' and have ${syllables} syllable(s). What am I? ....`);
      }

      set.add(`The word .... starts with the letter ${w[0].toUpperCase()}.`);
      set.add(`Can you guess the word ....?`);

      const SENSES = {
        bat: [{ clue: "An animal that flies is a ...." }, { clue: "You use a .... to hit a ball." }],
        bank: [{ clue: "You keep money in a ...." }, { clue: "A river .... is made of soil." }]
      };
      if (SENSES[w]) SENSES[w].forEach(s => set.add(s.clue));

      return [...set].sort(() => 0.5 - Math.random()).slice(0, count);
    }

    // Costruzione singola frase con input e icona ascolto
    function buildSentenceNode(sentenceText, correctWord) {
      const p = document.createElement("p");
      p.className = "sentence";

      // Sostituzione corretta del placeholder "...." (4 puntini letterali)
      const textToSpeak = sentenceText.replace(/\.\.\.\./g, 'blank');

      const listenIcon = document.createElement('span');
      listenIcon.textContent = 'ðŸ”Š';
      listenIcon.className = 'listen-icon-sentence';
      listenIcon.onclick = () => speakText(textToSpeak);
      p.appendChild(listenIcon);

      const sentenceTextContainer = document.createElement('span');
      const parts = sentenceText.split('....');
      parts.forEach((part, i) => {
        sentenceTextContainer.appendChild(document.createTextNode(part));
        if (i < parts.length - 1) {
          const input = document.createElement("input");
          input.type = "text";
          input.className = "sentence-input";
          input.dataset.correct = correctWord.toLowerCase();
          input.autocomplete = "off";
          input.style.width = `${Math.max(90, correctWord.length * 18 + 20)}px`;
          input.oninput = () => checkWord(input);
          sentenceTextContainer.appendChild(input);
        }
      });
      p.appendChild(sentenceTextContainer);
      return p;
    }

    // Verifica in tempo reale e punteggio
    function checkWord(inputElement) {
      const userInput = inputElement.value.trim().toLowerCase();
      const correctWord = inputElement.dataset.correct;
      inputElement.classList.remove("correct", "incorrect");
      if (userInput) inputElement.classList.add(userInput === correctWord ? "correct" : "incorrect");

      const allInputs = document.querySelectorAll('#riddle-box .sentence-input');
      let correctCount = 0;
      allInputs.forEach(inp => { if (inp.classList.contains('correct')) correctCount++; });
      scoreDisplay.textContent = `Score: ${correctCount} / ${allInputs.length}`;
    }

    // Genera TUTTE le frasi in UN SOLO BOX
    function generateRiddles() {
      const outputDiv = document.getElementById("output");
      const helper = document.getElementById("helper");
      outputDiv.innerHTML = "";
      scoreDisplay.textContent = "Score: 0";

      // Raccogli parole da 10 campi
      const words = [];
      document.querySelectorAll('.word-input-field').forEach(inp => {
        const w = inp.value.trim().toLowerCase();
        if (w) words.push(w);
      });
      const uniqueWords = [...new Set(words)];
      if (uniqueWords.length === 0) {
        helper.textContent = "Please add at least one word.";
        return;
      }
      helper.textContent = `Words used: ${uniqueWords.length}`;

      // 3 frasi per parola, tutte mescolate insieme
      const all = [];
      uniqueWords.forEach(w => {
        generateContextualSentences(w, 3).forEach(s => all.push({ s, w }));
      });
      all.sort(() => 0.5 - Math.random());

      const box = document.createElement('div');
      box.id = 'riddle-box';
      const title = document.createElement('div');
      title.className = 'riddle-title';
      title.textContent = 'ðŸ¤” Solve the riddles! ðŸ¤”';
      box.appendChild(title);

      all.forEach(item => box.appendChild(buildSentenceNode(item.s, item.w)));
      outputDiv.appendChild(box);
    }

    document.getElementById("btnGenerate").addEventListener("click", generateRiddles);
    document.getElementById("btnClear").addEventListener("click", () => {
      document.querySelectorAll('.word-input-field').forEach(inp => inp.value = '');
      document.getElementById("output").innerHTML = "";
      document.getElementById("helper").textContent = "";
      scoreDisplay.textContent = "Score: 0";
    });

    // Avvio
    createWordInputs();
  </script>
</body>
</html>
