<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spelling Game</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap");
    :root {
      --bg: #f0f8ff;
      --text: #444;
      --brand: #ff69b4;
      --brand-dark: #d1478e;
      --title: #ff6347;
      --title-shadow: #ffb6c1;
      --accent: #ff4500;
      --ok: #2e8b57;
      --no: #dc143c;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Fredoka One", cursive, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      text-align: center;
      padding: 20px;
    }
    #container {
      max-width: 900px;
      margin: 0 auto;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border: 5px solid #fff;
    }
    h1 {
      color: var(--title);
      font-size: 3.2em;
      text-shadow: 2px 2px 0px var(--title-shadow);
      margin-bottom: 14px;
    }
    p { font-size: 1.15em; color: #555; line-height: 1.5; }
    .controls { margin: 14px 0 8px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    textarea {
      width: 100%;
      height: 150px;
      padding: 15px;
      border-radius: 15px;
      border: 3px dashed #add8e6;
      font-size: 1.05em;
      margin-bottom: 8px;
      font-family: "Fredoka One", cursive;
      background-color: #f0f8ff;
      resize: vertical;
    }
    textarea:focus { outline: none; border-color: var(--brand); }
    button {
      background-color: var(--brand);
      color: white;
      padding: 12px 22px;
      border: none;
      border-radius: 50px;
      font-size: 1.2em;
      cursor: pointer;
      box-shadow: 0 4px var(--brand-dark);
      font-family: "Fredoka One", cursive;
    }
    button:active { transform: translateY(2px); box-shadow: 0 2px var(--brand-dark); }
    button.secondary { background: #eee; color: #333; box-shadow: 0 4px #ccc; }
    #output { margin-top: 22px; text-align: left; }
    .word-section {
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 18px;
    }
    .bg-1 { background-color: #B3E5FC; border-left: 10px solid #039BE5; }
    .bg-2 { background-color: #FFF9C4; border-left: 10px solid #FFD54F; }
    .bg-3 { background-color: #FFECB3; border-left: 10px solid #FFB74D; }
    .bg-4 { background-color: #C8E6C9; border-left: 10px solid #66BB6A; }
    .bg-5 { background-color: #F8BBD0; border-left: 10px solid #F06292; }
    .bg-6 { background-color: #E1BEE7; border-left: 10px solid #9575CD; }
    .word-title { font-size: 1.6em; color: var(--accent); font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;}
    .word-meta { font-size: .9em; color: #777; }
    .button-group { display: flex; gap: 8px; }
    .listen-button {
      background-color: #5cb85c;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 20px;
      font-size: 0.8em;
      cursor: pointer;
      box-shadow: 0 2px #449d44;
      font-family: "Fredoka One", cursive;
    }
    .listen-button:active { transform: translateY(1px); box-shadow: 0 1px #449d44; }
    .hint-button {
      background-color: #f0ad4e;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 20px;
      font-size: 0.8em;
      cursor: pointer;
      box-shadow: 0 2px #ec971f;
      font-family: "Fredoka One", cursive;
    }
    .hint-button:active { transform: translateY(1px); box-shadow: 0 1px #ec971f; }
    .hint-display {
      font-size: 1em;
      font-weight: normal;
      margin-left: 10px;
      color: #888;
      letter-spacing: 2px;
    }
    .sentence { font-size: 1.15em; margin-bottom: 12px; line-height: 2.1; }
    .sentence-input {
      border: none;
      border-bottom: 3px dashed #aaa;
      font-family: "Fredoka One", cursive;
      font-size: 1em;
      text-align: center;
      background-color: transparent;
      min-width: 90px;
      padding: 2px 4px;
    }
    .sentence-input:focus { outline: none; border-bottom: 3px solid var(--accent); }
    .correct { color: var(--ok); border-bottom-color: var(--ok) !important; font-weight: bold; }
    .incorrect { color: var(--no); border-bottom-color: var(--no) !important; }
    .verify-button {
      background-color: #26a69a;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 50px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 4px #00897b;
      font-family: "Fredoka One", cursive;
      margin-top: 10px;
    }
    .verify-button:active { transform: translateY(2px); box-shadow: 0 2px #00897b; }
    .helper { margin-top: 8px; font-size: .95em; color: #666; text-align: center; }

    .modal {
      display: none; position: fixed; z-index: 10; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto;
      background-color: rgba(0,0,0,0.95); padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe; margin: 5% auto; padding: 30px;
      border: 5px solid var(--brand); width: 80%; max-width: 500px;
      border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .modal-content h2 { color: var(--brand); font-size: 2em; margin-bottom: 10px; }
    .modal-content p { font-size: 1.2em; line-height: 1.4; margin-bottom: 20px; }
    .modal-input {
      width: 80%; padding: 10px; font-size: 1.2em; text-align: center;
      border: 2px solid #ccc; border-radius: 10px; font-family: "Fredoka One", cursive; margin-bottom: 10px;
    }
    .modal-input:focus { outline: none; border-color: var(--brand); }

    .show-message { display: block !important; }
    .message-box {
      background-color: white; border: 3px solid #ffa500; border-radius: 15px; padding: 20px;
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 10; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .message-box h3 { color: #ff4500; font-size: 1.5em; margin-bottom: 10px; }
    .message-box p { color: #555; font-size: 1.1em; margin-bottom: 15px; }
    .message-box button { background-color: var(--brand); color: white; border: none; border-radius: 50px; padding: 10px 20px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="container">
    <h1>ðŸŒŸ Spelling Game ðŸŒŸ</h1>
    <p>Enter up to <strong>10 words</strong> (one per line). For each word, <strong>10 sentences</strong> will be generated with a blank space for you to complete.</p>
    <textarea id="wordInput" rows="10" placeholder="Write your words here... for example:
sun
sea
school
book
car
dog
cat
tree
flowers
house"></textarea>
    <div class="controls">
      <button id="btnGenerate">Generate Sentences!</button>
      <button class="secondary" id="btnClear">Clear</button>
    </div>
    <div id="helper" class="helper"></div>
    <div id="scoreDisplay">Score: 0</div>
    <div id="output"></div>
  </div>

  <div id="verificationModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Verification</h2>
      <p id="modalSentence"></p>
      <input type="text" id="modalInput" class="modal-input" placeholder="Write the word here..." autocomplete="off">
      <br>
      <button id="modalVerifyBtn">Verify</button>
      <button id="modalSkipBtn" class="secondary">Skip</button>
    </div>
  </div>

  <div id="messageBox" class="message-box">
    <h3 id="messageTitle"></h3>
    <p id="messageText"></p>
    <button id="messageOkBtn">OK</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <script>
    const MAX_WORDS = 10;
    let score = 0;
    const scoreDisplay = document.getElementById("scoreDisplay");

    const verificationModal = document.getElementById("verificationModal");
    const modalSentence = document.getElementById("modalSentence");
    const modalInput = document.getElementById("modalInput");
    const modalVerifyBtn = document.getElementById("modalVerifyBtn");
    const modalSkipBtn = document.getElementById("modalSkipBtn");

    const messageBox = document.getElementById("messageBox");
    const messageTitle = document.getElementById("messageTitle");
    const messageText = document.getElementById("messageText");
    const messageOkBtn = document.getElementById("messageOkBtn");

    let currentWordToVerify = '';
    const backgroundColors = ['bg-1', 'bg-2', 'bg-3', 'bg-4', 'bg-5', 'bg-6'];
    let verifiedWordCount = 0;
    let totalWords = 0;

    function showMessage(title, text) {
      messageTitle.textContent = title;
      messageText.textContent = text;
      messageBox.classList.add('show-message');
    }
    messageOkBtn.addEventListener('click', () => messageBox.classList.remove('show-message'));

    function updateScore(delta) {
      score += delta;
      scoreDisplay.textContent = `Score: ${score}`;
    }

    function escapeRegex(s) {
      return s.replace(/[-\/^$*+?.()|[\]{}]/g, "\\$&");
    }

    function checkWord(inputElement) {
      const userInput = inputElement.value.trim().toLowerCase();
      const correctWord = inputElement.dataset.correct.toLowerCase();

      inputElement.classList.remove("correct", "incorrect");
      if (!userInput) return;

      if (userInput === correctWord) {
        inputElement.classList.add("correct");
      } else {
        inputElement.classList.add("incorrect");
      }

      const section = inputElement.closest('.word-section');
      const allInputs = section.querySelectorAll('.sentence-input');
      let completedCount = 0;
      allInputs.forEach(input => {
        if (input.classList.contains('correct')) { completedCount++; }
      });
      const progressSpan = section.querySelector('.progress-count');
      if (progressSpan) { progressSpan.textContent = `(${completedCount}/10)`; }
    }

    async function playSuccessJingle() {
      const synth = new Tone.Synth({
        oscillator: { type: "sawtooth" },
        envelope: { attack: 0.05, decay: 0.5, sustain: 0.2, release: 0.8 },
      }).toDestination();

      const notes = ["C4", "G3", "C4", "C4", "B3", "A3", "G3", "F#3", "G3", "A3", "B3", "C4"];
      const times = ["0", "0.5", "1", "1.5", "2.0", "2.5", "3.0", "3.5", "4.0", "4.5", "5.0", "5.5"];

      const part = new Tone.Part((time, note) => {
        synth.triggerAttackRelease(note, "0.4", time);
      }, notes.map((note, index) => [times[index], note])).start(0);

      if (Tone.context.state !== 'running') { await Tone.start(); }
      Tone.Transport.start();
      Tone.Transport.scheduleOnce(() => { Tone.Transport.stop(); }, "6");
    }

    function showVerificationModal(word) {
      const sentences = wordSentenceMap[word.toLowerCase()] || generateContextualSentences(word.toLowerCase());
      const randomIndex = Math.floor(Math.random() * sentences.length);
      const sentence = sentences[randomIndex];
      const displaySentence = sentence.replace(new RegExp(escapeRegex(word), 'gi'), '....');

      modalSentence.textContent = displaySentence;
      modalInput.value = '';
      modalInput.dataset.correct = word;
      currentWordToVerify = word;
      verificationModal.style.display = 'block';
      modalInput.focus();
    }

    function verifyWord() {
      const userInput = modalInput.value.trim().toLowerCase();
      const correctWord = modalInput.dataset.correct.toLowerCase();

      if (userInput === correctWord) {
        updateScore(1);
        showMessage("Correct!", `Great! The word is "${correctWord}". You earned 1 point!`);
        const section = document.querySelector(`.word-section[data-word="${currentWordToVerify}"]`);
        if (section) { section.querySelector('.word-title').style.color = 'var(--ok)'; }
        verifiedWordCount++;
        if (verifiedWordCount >= totalWords) {
          if (score === totalWords) {
            showMessage("Perfect Score!", "Congratulations! You spelled all words correctly and earned a perfect score!");
            playSuccessJingle();
          } else {
            showMessage("Game Over!", "You have completed all the words. Try again to get a perfect score!");
          }
        }
        hideModal();
      } else {
        showMessage("Try Again!", `That's not quite right. Keep practicing!`);
      }
    }

    function hideModal() {
      verificationModal.style.display = 'none';
      currentWordToVerify = '';
    }

    modalVerifyBtn.addEventListener('click', verifyWord);
    modalInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') verifyWord(); });
    modalSkipBtn.addEventListener('click', () => hideModal());

    // Prefer British English voice (en-GB). Fallback to lang only.
    function chooseBritishVoice() {
      const list = window.speechSynthesis.getVoices() || [];
      return list.find(v => /en-GB/i.test(v.lang) && /female/i.test(v.name)) ||
             list.find(v => /en-GB/i.test(v.lang)) ||
             list.find(v => /UK|British/i.test(v.name)) ||
             list.find(v => /^en[-_]/i.test(v.lang));
    }

    function speakWord(buttonElement) {
      if (!('speechSynthesis' in window)) {
        showMessage("Speech API Not Supported", "The Web Speech API is not supported in this browser. Try Chrome or Firefox.");
        return;
      }
      const word = buttonElement.dataset.word;
      const utterance = new SpeechSynthesisUtterance(word);
      
      const setVoiceAndSpeak = () => {
        const voice = chooseBritishVoice();
        if (voice) {
          utterance.voice = voice;
          utterance.lang = voice.lang; 
        } else {
          utterance.lang = 'en-GB';
        }
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      };

      if ((window.speechSynthesis.getVoices() || []).length === 0) {
        window.speechSynthesis.onvoiceschanged = setVoiceAndSpeak;
      } else {
        setVoiceAndSpeak();
      }
    }

    function giveHint(buttonElement) {
      const word = buttonElement.dataset.word;
      const hintDisplay = buttonElement.nextElementSibling;
      let hintIndex = parseInt(buttonElement.dataset.hintIndex, 10);
      if (hintIndex < word.length) {
        updateScore(-1);
        showMessage("Hint Used!", "You lost 1 point for using a hint. Keep going!");
        const hintedPart = word.substring(0, hintIndex + 1);
        const remainingPart = "_".repeat(word.length - (hintIndex + 1));
        hintDisplay.textContent = `${hintedPart}${remainingPart}`;
        hintIndex++;
        buttonElement.dataset.hintIndex = hintIndex;
      }
      if (hintIndex === word.length) {
        buttonElement.disabled = true;
        buttonElement.textContent = "Hint Given";
        buttonElement.style.opacity = 0.5;
      }
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // TIER 1: BANCA FRASI SPECIFICHE (MASSIMA PERTINENZA)
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const wordSentenceMap = {
      sun: [
        "The .... is a giant star that gives us light and heat every day.",
        "Without the ...., plants couldn't make their own food.",
        "The .... rises in the east and sets in the west.",
        "On a clear day, you can feel the warmth of the .... on your skin.",
        "A sunflower turns its head to follow the .... across the sky.",
      ],
      moon: [
        "The .... lights up the night sky and it changes shape.",
        "Neil Armstrong was the first person to walk on the .....",
        "A full .... is big and round and very bright.",
        "The .... has craters on its surface that you can see with a telescope.",
        "Wolves in stories sometimes howl at the full ....",
      ],
      dog: [
        "A .... is often called 'man's best friend' because it is loyal.",
        "You might take your pet .... for a walk in the park.",
        "A .... wags its tail when it's happy to see you.",
        "A puppy is a baby .... that is very playful.",
        "A .... likes to fetch a ball or a stick.",
      ],
      cat: [
          "A .... purrs when it is happy and content.",
          "A kitten is a baby .... that loves to play with string.",
          "A .... has sharp claws and soft fur.",
          "Unlike a dog, a .... often likes to sleep in a warm spot.",
          "A .... says 'meow' when it wants food.",
      ],
      sea: [
          "The .... is a large body of salt water.",
          "You can build sandcastles on the beach next to the ....",
          "Boats and ships sail on the .... to travel to other places.",
          "Fish, whales, and crabs live in the ....",
          "The waves of the .... make a relaxing sound.",
      ],
      school: [
          ".... is a place where children go to learn new things.",
          "Your teacher helps you read and write at ....",
          "You play with your friends in the playground at ....",
          "A classroom is a room in a .... with desks and a board.",
          "You carry your books in a bag to ....",
      ],
      book: [
          "You read a .... to learn about new stories and ideas.",
          "A library is a place full of many different .... to borrow.",
          "Each .... has a cover, pages, and words inside.",
          "You turn the page of a .... to continue the story.",
          "A story.... might have pictures to go with the words.",
      ],
      car: [
          "A .... is a vehicle with four wheels that you drive on the road.",
          "You must wear a seatbelt when you are riding in a ....",
          "A .... needs petrol or electricity to make it go.",
          "Traffic lights tell a .... when to stop and when to go.",
          "A garage is where you park a .... at night.",
      ],
      tree: [
          "A .... has a trunk, branches, and green leaves.",
          "Birds often build their nests high up in a ....",
          "In autumn, the leaves of a .... might turn red, yellow, or brown.",
          "A forest is a place with many, many .... growing together.",
          "An apple .... grows apples that you can eat.",
      ],
      flowers: [
          ".... are colourful plants that grow in a garden or a park.",
          "Bees like to visit .... to collect nectar.",
          "You can pick a bunch of .... to put in a vase.",
          "Roses, daisies, and tulips are all types of ....",
          "Many .... have a lovely, sweet smell.",
      ],
      house: [
          "A .... is a building where a family lives.",
          "Your .... has a roof to keep the rain out.",
          "A .... has rooms like a kitchen, a bedroom, and a living room.",
          "The front door of a .... has a number on it.",
          "You sleep in your bed in your .... at night.",
      ]
    };

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // TIER 2 & 3: GENERATORE CONTESTUALE MIGLIORATO
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function getArticle(word) { return /^[aeiou]/i.test(word) ? "an" : "a"; }
    function syllableCount(w) { return (w.match(/[aeiouy]+/g)?.length || 1); }
    function syllableHint(w) {
      const n = syllableCount(w);
      return `${n} syllable${n>1?"s":""}`;
    }
    function ensureUnique(sentences) {
      const seen = new Set();
      const out = [];
      for (const s of sentences) {
        const norm = s.toLowerCase().replace(/\s+/g," ").replace(/[^\w. ]/g,"").trim();
        if (norm && !seen.has(norm)) { seen.add(norm); out.push(s); }
      }
      return out;
    }
    function shuffleAndPick(arr, count) {
      const a = [...arr];
      for (let i=a.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
      return a.slice(0, count);
    }
    function simpleRhyme(word) {
      const bank = {
        sun: "run", moon: "spoon", star: "car", dog: "log", cat: "hat", bird: "word",
        red: "bed", blue: "shoe", apple: "dapple", bread: "head", tree: "see", car: "star"
      };
      return bank[word.toLowerCase()] || null;
    }
    function morphology(word) {
      const w = word.toLowerCase();
      const info = { suffix:null, isPlural:false, isVerb:false };
      if (w.length > 3 && w.endsWith("ing")) { info.suffix = "-ing"; info.isVerb = true; }
      else if (w.length > 3 && w.endsWith("ed")) { info.suffix = "-ed"; info.isVerb = true; }
      else if (w.endsWith("s") && !w.endsWith("ss")) { info.suffix = "-s"; info.isPlural = !info.isVerb; }
      return info;
    }
    const SENSES = {
      bat: [
        { cat:"animal", clue:"An animal that flies at night is a ...." },
        { cat:"object", clue:"To hit a baseball, you use a ...." }
      ],
      seal: [
        { cat:"animal", clue:"An animal that barks and swims in the sea is a ...." },
        { cat:"action", clue:"To close a letter, you .... the envelope." }
      ],
      bank: [
        { cat:"place", clue:"A place that keeps money safe is a ...." },
        { cat:"nature", clue:"The side of a river is called a river ...." }
      ],
    };

    function generateContextualSentences(word) {
      const w = word.toLowerCase();
      const info = {
        word: w,
        article: getArticle(w),
        first: w[0]?.toUpperCase() || "",
        syllables: syllableHint(w),
        rhyme: simpleRhyme(w),
        morph: morphology(w),
        senses: SENSES[w] || null,
        isPlural: morphology(w).isPlural,
      };

      const patterns = [
        // Phonics / Structure
        { condition: (i) => true, generator: (i) => `The word .... starts with the letter ${i.first}.` },
        { condition: (i) => true, generator: (i) => `The word .... has ${i.syllables}.` },
        { condition: (i) => i.rhyme, generator: (i) => `The word .... rhymes with "${i.rhyme}".` },
        // Simple Definition / Category
        { condition: (i) => !i.isPlural, generator: (i) => `${i.article.toUpperCase()} .... is a type of thing you can see.` },
        { condition: (i) => i.isPlural, generator: (i) => `.... are things you can count.` },
        // Senses (if available)
        { condition: (i) => i.senses, generator: (i) => i.senses[0].clue },
        { condition: (i) => i.senses && i.senses.length > 1, generator: (i) => i.senses[1].clue },
        // Simple context
        { condition: (i) => !i.isPlural, generator: (i) => `You can find ${i.article} .... in a story book.` },
        { condition: (i) => i.isPlural, generator: (i) => `You can find .... in many places.` },
        { condition: (i) => !i.isPlural, generator: (i) => `Think about what ${i.article} .... is used for.` },
        // Action / Use
        { condition: (i) => i.morph.isVerb, generator: (i) => `To .... is an action you can do.` },
        // Contrast
        { condition: (i) => i.word === "big", generator: (i) => `The opposite of small is ....` },
        { condition: (i) => i.word === "small", generator: (i) => `The opposite of big is ....` },
        { condition: (i) => i.word === "hot", generator: (i) => `The opposite of cold is ....` },
        { condition: (i) => i.word === "cold", generator: (i) => `The opposite of hot is ....` },
        // Fallbacks
        { condition: (i) => true, generator: (i) => `Can you spell the word ....?` },
        { condition: (i) => true, generator: (i) => `Try to write the word .... in the space.` },
      ];

      const applicable = patterns.filter(p => p.condition(info));
      const candidates = applicable.map(p => p.generator(info));
      
      const uniqueSentences = ensureUnique(candidates);
      const shuffled = shuffleAndPick(uniqueSentences, 15); // get more than 10 to ensure variety
      
      // Sort by length to have simpler sentences first
      shuffled.sort((a,b) => a.length - b.length);

      // Add a final, always-useful hint if space allows
      if (shuffled.length < 10) {
        shuffled.push(`Say the sounds of the .... out loud to help you spell it.`);
      }

      return ensureUnique(shuffled).slice(0, 10);
    }
    
    function buildSentenceNodes(sentence, lowerCaseWord) {
      const sentenceP = document.createElement("p");
      sentenceP.className = "sentence";
      const escaped = escapeRegex(lowerCaseWord);
      const regex = new RegExp(`\\b${escaped}\\b|\\.{3,}`, "gi");
      let lastIndex = 0;
      let anyMatch = false;
      let match;

      while ((match = regex.exec(sentence)) !== null) {
        anyMatch = true;
        sentenceP.appendChild(document.createTextNode(sentence.slice(lastIndex, match.index)));
        const input = document.createElement("input");
        input.type = "text";
        input.className = "sentence-input";
        input.dataset.correct = lowerCaseWord;
        input.setAttribute("oninput", "checkWord(this)");
        input.setAttribute("autocomplete", "off");
        input.setAttribute("aria-label", `Fill in: ${lowerCaseWord}`);
        const width = Math.max(90, lowerCaseWord.length * 18 + 20);
        input.style.width = width + "px";
        sentenceP.appendChild(input);
        lastIndex = match.index + match[0].length;
      }
      sentenceP.appendChild(document.createTextNode(sentence.slice(lastIndex)));

      if (!anyMatch) {
        sentenceP.appendChild(document.createTextNode(" "));
        const input = document.createElement("input");
        input.type = "text";
        input.className = "sentence-input";
        input.dataset.correct = lowerCaseWord;
        input.setAttribute("oninput", "checkWord(this)");
        input.setAttribute("autocomplete", "off");
        input.setAttribute("aria-label", `Fill in: ${lowerCaseWord}`);
        const width = Math.max(90, lowerCaseWord.length * 18 + 20);
        input.style.width = width + "px";
        sentenceP.appendChild(input);
      }
      return sentenceP;
    }

    function renderWordSection(word, sentences, colorClass) {
      const section = document.createElement("div");
      section.className = "word-section";
      section.dataset.word = word;
      section.classList.add(colorClass);

      const title = document.createElement("div");
      title.className = "word-title";
      const titleText = document.createElement("span");
      titleText.textContent = `ðŸ’¡ Fill in the blanks!`;
      title.appendChild(titleText);
      
      const buttonGroup = document.createElement("div");
      buttonGroup.className = "button-group";
      
      const listenButton = document.createElement("button");
      listenButton.textContent = "Listen";
      listenButton.className = "listen-button";
      listenButton.setAttribute("data-word", word);
      listenButton.onclick = () => speakWord(listenButton);
      buttonGroup.appendChild(listenButton);

      const hintButton = document.createElement("button");
      hintButton.textContent = "Hint";
      hintButton.className = "hint-button";
      hintButton.setAttribute("data-word", word);
      hintButton.setAttribute("data-hint-index", "0");
      hintButton.onclick = () => giveHint(hintButton);
      buttonGroup.appendChild(hintButton);

      const hintDisplay = document.createElement("span");
      hintDisplay.className = "hint-display";
      hintDisplay.textContent = "_".repeat(word.length);
      buttonGroup.appendChild(hintDisplay);

      const progressCount = document.createElement("span");
      progressCount.className = "word-meta progress-count";
      progressCount.textContent = `(0/10)`;
      
      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.style.alignItems = 'center';
      header.style.width = '100%';
      header.appendChild(title);
      header.appendChild(buttonGroup);
      section.appendChild(header);

      sentences.forEach((sentence) => {
        const nodes = buildSentenceNodes(sentence, word.toLowerCase());
        section.appendChild(nodes);
      });
      
      const footer = document.createElement('div');
      footer.style.display = 'flex';
      footer.style.justifyContent = 'space-between';
      footer.style.alignItems = 'center';
      footer.style.marginTop = '15px';
      
      const verifyButton = document.createElement("button");
      verifyButton.textContent = "Check Word";
      verifyButton.className = "verify-button";
      verifyButton.onclick = () => showVerificationModal(word);
      footer.appendChild(verifyButton);
      footer.appendChild(progressCount);
      section.appendChild(footer);

      return section;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function generateSentences() {
      const raw = document.getElementById("wordInput").value.trim();
      const outputDiv = document.getElementById("output");
      const helper = document.getElementById("helper");
      outputDiv.innerHTML = "";
      updateScore(-score);
      verifiedWordCount = 0;

      let words = raw.split(/\r?\n/).map((w) => w.trim()).filter(Boolean);
      const unique = [];
      const seen = new Set();
      for (const w of words) {
        const key = w.toLowerCase();
        if (!seen.has(key)) { unique.push(w); seen.add(key); }
      }
      words = unique.slice(0, MAX_WORDS);
      totalWords = words.length;

      if (words.length === 0) {
        helper.textContent = "Please enter at least one word (max 10).";
        return;
      }
      helper.textContent = `Words used: ${words.length}/${MAX_WORDS}`;

      const shuffledColors = shuffleArray([...backgroundColors]);
      words.forEach((word, index) => {
        const key = word.toLowerCase();
        // Tiered approach: use specific map first, then fall back to generator
        const sentencesRaw = wordSentenceMap[key] || generateContextualSentences(key);
        const sentences = ensureUnique(sentencesRaw).slice(0, 10);
        const colorClass = shuffledColors[index % shuffledColors.length];
        const section = renderWordSection(word, sentences, colorClass);
        outputDiv.appendChild(section);
      });
    }

    document.getElementById("btnGenerate").addEventListener("click", generateSentences);
    document.getElementById("btnClear").addEventListener("click", () => {
      document.getElementById("wordInput").value = "";
      document.getElementById("output").innerHTML = "";
      document.getElementById("helper").textContent = "";
      updateScore(-score);
      verifiedWordCount = 0;
      totalWords = 0;
      document.getElementById("wordInput").focus();
    });
    document.getElementById("wordInput").addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") generateSentences();
    });
  </script>
</body>
</html>
